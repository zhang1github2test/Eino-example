package main

import (
	"Eino-example/util"
	"context"
	"fmt"
	"github.com/cloudwego/eino-ext/components/model/openai"
	"github.com/cloudwego/eino/compose"
	"github.com/cloudwego/eino/flow/agent/react"
	"github.com/cloudwego/eino/schema"
	"github.com/joho/godotenv"
	"io"
	"log"
	"os"
)

func main() {
	// åŠ è½½ .env æ–‡ä»¶
	err := godotenv.Load()
	if err != nil {
		log.Fatal("Error loading .env file:", err)
	}
	// è¯»å–ç¯å¢ƒå˜é‡
	baseUrl := os.Getenv("OPENAI_BASE_URL")
	apiKey := os.Getenv("OPENAI_API_KEY")

	ctx := context.TODO()

	chatModel, err := openai.NewChatModel(context.TODO(), &openai.ChatModelConfig{
		Model:   "qwen-vl-plus", // ä½¿ç”¨çš„æ¨¡å‹ç‰ˆæœ¬
		APIKey:  apiKey,         // OpenAI API å¯†é’¥
		BaseURL: baseUrl,
	})
	if err != nil {
		log.Fatal(err)
	}

	// åˆ›å»ºå·¥å…·
	//searchTool, err := duckduckgo.NewTextSearchTool(context.TODO(), &duckduckgo.Config{})
	//if err != nil {
	//	log.Fatal(err)
	//
	//}

	//// ç¬¬ä¸€ç§åˆ›å»ºå·¥å…·çš„æ–¹å¼ï¼šä½¿ç”¨NewToolæ–¹å¼åˆ›å»º
	//addTodoTool := create_tool.GetAddTodoTool()
	//
	////ç¬¬äºŒç§åˆ›å»ºå·¥å…·çš„æ–¹å¼ï¼šä½¿ç”¨InferToolæ–¹å¼åˆ›å»º
	//updateTodoTool := create_tool.GetUpdateTodoTool()
	//
	////ç¬¬ä¸‰ç§åˆ›å»ºå·¥å…·çš„æ–¹å¼ï¼šå®ç°InvokableToolæ¥å£
	//listTodoTool := &create_tool.ListTodoTool{}
	//
	//// ç¬¬å››ç§åˆ›å»ºå·¥å…·çš„æ–¹å¼ï¼šä½¿ç”¨å®˜æ–¹ç°æœ‰çš„å·¥å…·
	//newTool, err := get.NewTool(ctx, &get.Config{})
	//if err != nil {
	//	log.Fatal(err)
	//
	//}
	//
	//// åˆ›å»ºToolsNode
	//conf := compose.ToolsNodeConfig{
	//	Tools: []tool.BaseTool{newTool, addTodoTool, updateTodoTool, listTodoTool}, // å·¥å…·å¯ä»¥æ˜¯ InvokableTool æˆ– StreamableTool
	//}
	//
	//// åˆ›å»º agent
	agent, err := react.NewAgent(ctx, &react.AgentConfig{
		ToolCallingModel: chatModel,
		ToolsConfig:      compose.ToolsNodeConfig{},
	})
	//
	//MULTI_MATH_PROBLEM_PROMPT := `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ•°å­¦ä½œä¸šæ‰¹æ”¹AIï¼Œèƒ½å¤Ÿå¤„ç†ä¸€å¼ å›¾åƒä¸­åŒ…å«å¤šä¸ªæ•°å­¦é¢˜ç›®åŠå¯¹åº”è§£ç­”çš„å¤æ‚åœºæ™¯ã€‚
	//
	//è¯·æŒ‰ä»¥ä¸‹æ­¥éª¤å¤„ç†ï¼š
	//
	//æ­¥éª¤1ï¼šæ£€æµ‹æ‰€æœ‰ç‹¬ç«‹é¢˜ç›®åŒºåŸŸ
	//- å°†å›¾åƒåˆ’åˆ†ä¸ºè‹¥å¹²ä¸ª"é¢˜ç›®å•å…ƒ"ï¼Œæ¯ä¸ªå•å…ƒåŒ…å«ï¼š
	//- é¢˜å¹²ï¼ˆå¯èƒ½å°åˆ·æˆ–æ‰‹å†™ï¼‰
	//- å­¦ç”Ÿçš„è§£ç­”è¿‡ç¨‹ä¸ç­”æ¡ˆï¼ˆæ‰‹å†™ä¸ºä¸»ï¼‰
	//- ä¸ºæ¯ä¸ªé¢˜ç›®å•å…ƒåˆ†é…ä¸€ä¸ªå”¯ä¸€ IDï¼ˆå¦‚ problem_1, problem_2...ï¼‰
	//- è¾“å‡ºæ¯ä¸ªé¢˜ç›®çš„å½’ä¸€åŒ–è¾¹ç•Œæ¡†ï¼ˆproblem_bboxï¼‰
	//
	//æ­¥éª¤2ï¼šå¯¹æ¯ä¸ªé¢˜ç›®ç‹¬ç«‹åˆ¤é¢˜
	//å¯¹æ¯ä¸ªé¢˜ç›®å•å…ƒï¼Œæ‰§è¡Œï¼š
	//1. é‡è¿°é¢˜ç›®
	//2. è½¬å½•å­¦ç”Ÿè§£ç­”
	//3. åˆ†æé”™è¯¯ï¼ˆå¦‚æœ‰ï¼‰
	//4. ä¸ºæ¯ä¸ªé”™è¯¯è¿”å›å…¶åœ¨æ•´å¼ å›¾åƒä¸­çš„å½’ä¸€åŒ–åæ ‡ï¼ˆerror_bboxï¼‰
	//
	//æ³¨æ„ï¼šerror_bbox æ˜¯ç›¸å¯¹äºæ•´å¼ åŸå›¾çš„åæ ‡ï¼Œä¸æ˜¯é¢˜ç›®å­åŒºåŸŸï¼
	//
	//æ­¥éª¤3ï¼šç»“æ„åŒ– JSON è¾“å‡º
	//è¯·ä¸¥æ ¼æŒ‰ä»¥ä¸‹æ ¼å¼è¾“å‡ºï¼ˆåˆæ³• JSONï¼‰ï¼š
	//
	//{
	//"total_problems_detected": 3,
	//"problems": [
	//{
	//"problem_id": "problem_1",
	//"problem_bbox": [x1, y1, x2, y2],
	//"recognized_question": "é¢˜ç›®1åŸæ–‡",
	//"student_answer_transcript": "è§£ç­”1å…¨æ–‡",
	//"errors": [
	//{
	//"error_type": "è®¡ç®—é”™è¯¯",
	//"description": "3Ã—4 ç®—æˆ 10",
	//"error_bbox": [ex1, ey1, ex2, ey2],
	//"correct_solution": "åº”ä¸º 12"
	//}
	//],
	//"final_verdict": "é”™è¯¯",
	//"score": 0
	//},
	//{
	//"problem_id": "problem_2",
	//"problem_bbox": [x1, y1, x2, y2],
	//"recognized_question": "é¢˜ç›®2åŸæ–‡",
	//"student_answer_transcript": "è§£ç­”2",
	//"errors": [],
	//"final_verdict": "æ­£ç¡®",
	//"score": 100
	//}
	//]
	//}
	//
	//åæ ‡è¯´æ˜ï¼š
	//- æ‰€æœ‰ bbox æ ¼å¼ï¼š[x_min, y_min, x_max, y_max]
	//- æ‰€æœ‰åæ ‡ å½’ä¸€åŒ–åˆ° [0,1] èŒƒå›´ï¼ŒåŸºäºåŸå›¾å®½åº¦å’Œé«˜åº¦
	//- (0,0) = å›¾åƒå·¦ä¸Šè§’ï¼Œ(1,1) = å³ä¸‹è§’
	//
	//é‡è¦çº¦æŸï¼š
	//- ä¸è¦åˆå¹¶é¢˜ç›®ï¼šå³ä½¿é¢˜ç›®æŒ¨å¾—å¾ˆè¿‘ï¼Œåªè¦é€»è¾‘ç‹¬ç«‹ï¼Œå°±åº”åˆ†ä¸ºä¸¤ä¸ª problem
	//- æ— æ³•åˆ†ç¦»æ—¶ï¼šè‹¥é¢˜ç›®ä¸¥é‡é‡å ã€æ— æ³•åŒºåˆ†ï¼Œå¯åˆå¹¶ä¸ºä¸€ä¸ª problemï¼Œå¹¶åœ¨ description ä¸­è¯´æ˜
	//- ç¦æ­¢çŒœæµ‹ï¼šè‹¥æŸé¢˜å›¾åƒæ¨¡ç³Šã€ç¼ºå¤±å…³é”®éƒ¨åˆ†ï¼Œerrors å¯ä¸ºç©ºï¼Œä½† final_verdict è®¾ä¸º "æ— æ³•åˆ¤é¢˜"ï¼Œå¹¶è¯´æ˜åŸå› 
	//- è‹¥å­¦ç”Ÿæœªä½œç­”ï¼Œfinal_verdict è®¾ä¸º "æœªä½œç­”"ï¼Œscore è®¾ä¸º 0
	//`

	const MULTI_MATH_PROBLEM_PROMPT = `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ•°å­¦ä½œä¸šæ‰¹æ”¹AIï¼Œèƒ½å¤Ÿå¤„ç†å›¾åƒä¸­åŒ…å«å¤šä¸ªæ•°å­¦é¢˜ç›®åŠå¯¹åº”è§£ç­”çš„å¤æ‚åœºæ™¯ã€‚
	è¯·æŒ‰ä»¥ä¸‹æ­¥éª¤å¤„ç†ï¼š
	æ­¥éª¤1ï¼šæ£€æµ‹æ‰€æœ‰ç‹¬ç«‹é¢˜ç›®åŒºåŸŸ
	- å°†å›¾åƒåˆ’åˆ†ä¸ºè‹¥å¹²ä¸ª"é¢˜ç›®å•å…ƒ"ï¼Œæ¯ä¸ªå•å…ƒåŒ…å«ï¼š
	 - é¢˜å¹²ï¼ˆå¯èƒ½å°åˆ·æˆ–æ‰‹å†™ï¼‰
	 - å­¦ç”Ÿçš„è§£ç­”è¿‡ç¨‹ä¸ç­”æ¡ˆï¼ˆæ‰‹å†™ä¸ºä¸»ï¼‰
	- ä¸ºæ¯ä¸ªé¢˜ç›®å•å…ƒåˆ†é…ä¸€ä¸ªå”¯ä¸€ IDï¼ˆå¦‚ problem_1, problem_2...ï¼‰
	- è¾“å‡ºæ¯ä¸ªé¢˜ç›®çš„å½’ä¸€åŒ–è¾¹ç•Œæ¡†ï¼ˆproblem_bboxï¼‰
	
	æ­¥éª¤2ï¼šå¯¹æ¯ä¸ªé¢˜ç›®ç‹¬ç«‹åˆ¤é¢˜
	å¯¹æ¯ä¸ªé¢˜ç›®å•å…ƒï¼Œæ‰§è¡Œï¼š
	1. é‡è¿°é¢˜ç›®
	2. åˆ¤æ–­å­¦ç”Ÿæ˜¯å¦ä½œç­”ï¼š
	  - âœ… ä½œç­”ï¼šæœ‰æ–‡å­—ã€å…¬å¼ã€æ•°å­—ã€ç¬¦å·ã€å›¾å½¢ç­‰æœ‰æ•ˆå†…å®¹
	  - âŒ æœªä½œç­”ï¼šå®Œå…¨ç©ºç™½ã€ä»…æœ‰é¢˜å·ã€ä»…ç”»çº¿ã€ä»…åœˆé¢˜ã€ä»…å†™â€œä¸ä¼šâ€â€œç©ºâ€â€œï¼Ÿâ€ï¼Œæˆ–å†…å®¹æ— æ³•è¾¨è®¤
	3. è‹¥å­¦ç”Ÿ**æœªä½œç­”**ï¼Œè¯·ç«‹å³åœæ­¢åˆ†æï¼Œä¸è¦æ¨æ–­ã€ä¸è¦ç¼–é€ ã€ä¸è¦çŒœæµ‹ç­”æ¡ˆæˆ–è¿‡ç¨‹ï¼
	4. è‹¥å­¦ç”Ÿ**å·²ä½œç­”**ï¼Œåˆ™ï¼š
	  - è½¬å½•å­¦ç”Ÿè§£ç­”å†…å®¹ï¼ˆé€å­—ä¿ç•™ï¼ŒåŒ…æ‹¬é”™å­—ã€æ¶‚æ”¹ï¼‰
	  - åˆ†æé”™è¯¯ï¼ˆå¦‚æœ‰ï¼‰
	  - ä¸ºæ¯ä¸ªé”™è¯¯è¿”å›å…¶åœ¨æ•´å¼ å›¾åƒä¸­çš„å½’ä¸€åŒ–åæ ‡ï¼ˆerror_bboxï¼‰
	
	âš ï¸ é‡è¦åŸåˆ™ï¼š
	- ä»»ä½•**ç©ºç™½åŒºåŸŸ**ï¼ˆæ— ä»»ä½•æ‰‹å†™/å°åˆ·å†…å®¹ï¼‰ â†’ å¿…é¡»åˆ¤å®šä¸ºâ€œæœªä½œç­”â€
	- ä»…å†™â€œç©ºâ€ã€â€œä¸ä¼šâ€ã€â€œï¼Ÿâ€ã€â€œâ€”â€”â€ã€â€œxâ€ã€â€œâˆšâ€ç­‰æ— å†…å®¹ç¬¦å· â†’ è§†ä¸ºâ€œæœªä½œç­”â€
	- æ¶‚é»‘ã€åå¤æ“¦é™¤ã€é“…ç¬”æ·¡ç—•ã€æ¨¡ç³Šä¸æ¸… â†’ è‹¥æ— æ³•è¯†åˆ«ä»»ä½•æœ‰æ•ˆæ•°å­¦å†…å®¹ â†’ è§†ä¸ºâ€œæœªä½œç­”â€
	- **ç¦æ­¢å¯¹ç©ºç™½åŒºåŸŸè¿›è¡Œä»»ä½•æ•°å­¦æ¨ç†**ï¼å³ä½¿ä½ â€œçŸ¥é“â€è¿™é“é¢˜çš„æ ‡å‡†ç­”æ¡ˆï¼Œä¹Ÿä¸å¾—å‡è®¾å­¦ç”Ÿå†™äº†ä»€ä¹ˆï¼
	
	æ­¥éª¤3ï¼šç»“æ„åŒ– JSON è¾“å‡º
	è¯·ä¸¥æ ¼æŒ‰ä»¥ä¸‹æ ¼å¼è¾“å‡ºï¼ˆåˆæ³• JSONï¼‰ï¼š
	
	{
	 "total_problems_detected": 3,
	 "problems": [
	   {
	     "problem_id": "problem_1",
	     "problem_bbox": [x1, y1, x2, y2],
	     "recognized_question": "é¢˜ç›®1åŸæ–‡",
	     "student_answer_transcript": "å­¦ç”Ÿä½œç­”å†…å®¹å…¨æ–‡ï¼Œè‹¥æœªä½œç­”åˆ™ä¸ºç©ºå­—ç¬¦ä¸²",
	     "is_unanswered": true,  // âš ï¸ æ–°å¢å­—æ®µï¼šæ˜¯å¦æœªä½œç­”
	     "errors": [],           // è‹¥ is_unanswered ä¸º trueï¼Œerrors å¿…é¡»ä¸ºç©ºæ•°ç»„
	     "final_verdict": "æœªä½œç­”", // åªèƒ½æ˜¯ï¼š"æ­£ç¡®" / "éƒ¨åˆ†æ­£ç¡®" / "é”™è¯¯" / "æœªä½œç­”"
	     "score": 0
	   },
	   {
	     "problem_id": "problem_2",
	     "problem_bbox": [x1, y1, x2, y2],
	     "recognized_question": "é¢˜ç›®2åŸæ–‡",
	     "student_answer_transcript": "Î” = bÂ² + 4ac = 25 + 24 = 49\nx = (-5 Â± 7)/2",
	     "is_unanswered": false,
	     "errors": [
	       {
	         "error_type": "å…¬å¼é”™è¯¯",
	         "description": "åˆ¤åˆ«å¼ç¬¦å·é”™è¯¯ï¼Œåº”ä¸º bÂ² - 4acï¼Œè€Œé bÂ² + 4ac",
	         "error_bbox": [ex1, ey1, ex2, ey2],
	         "correct_solution": "Î” = bÂ² - 4ac = 25 - 24 = 1"
	       }
	     ],
	     "final_verdict": "é”™è¯¯",
	     "score": 40
	   }
	 ]
	}
	
	åæ ‡è¯´æ˜ï¼š
	- æ‰€æœ‰ bbox æ ¼å¼ï¼š[x_min, y_min, x_max, y_max]
	- æ‰€æœ‰åæ ‡ å½’ä¸€åŒ–åˆ° [0,1] èŒƒå›´ï¼ŒåŸºäºåŸå›¾å®½åº¦å’Œé«˜åº¦
	- (0,0) = å›¾åƒå·¦ä¸Šè§’ï¼Œ(1,1) = å³ä¸‹è§’
	
	é‡è¦çº¦æŸï¼š
	- âœ… å¿…é¡»åˆ¤æ–­ "is_unanswered" å­—æ®µ
	- âœ… å¦‚æœ is_unanswered == trueï¼Œåˆ™ï¼š
	   - student_answer_transcript å¿…é¡»æ˜¯ ""ï¼ˆç©ºå­—ç¬¦ä¸²ï¼‰
	   - errors å¿…é¡»æ˜¯ []ï¼ˆç©ºæ•°ç»„ï¼‰
	   - final_verdict å¿…é¡»æ˜¯ "æœªä½œç­”"
	   - ä¸å¾—ç”Ÿæˆä»»ä½•é”™è¯¯åˆ†ææˆ–æ­£ç¡®ç­”æ¡ˆ
	- âŒ ç¦æ­¢å°†ç©ºç™½ã€æ¶‚æ”¹ã€æ¨¡ç³Šã€ä»…å†™é¢˜å·ç­‰è¯¯åˆ¤ä¸ºâ€œä½œç­”â€
	- âŒ ç¦æ­¢æ¨æµ‹å­¦ç”Ÿâ€œå¯èƒ½å†™äº†ä»€ä¹ˆâ€
	- âŒ è‹¥å›¾åƒä¸­è¯¥é¢˜ç›®åŒºåŸŸæ— ä»»ä½•å¯è¾¨è¯†å†…å®¹ï¼Œä¹Ÿå¿…é¡»è®¾ is_unanswered: true
	- âŒ è‹¥å­¦ç”Ÿåªå†™äº†â€œä¸ä¼šâ€â€œç©ºâ€â€œï¼Ÿâ€â€œâ€”â€”â€ç­‰ï¼Œä¹Ÿè§†ä¸ºæœªä½œç­”
	- âœ… å¯¹äºâ€œä½œç­”â€é¢˜ç›®ï¼Œå¿…é¡»é€å­—è½¬å½•ï¼Œå³ä½¿æœ‰é”™å­—ã€ä¹±å†™ï¼Œä¹Ÿä¿ç•™åŸè²Œ`

	//const MULTI_IMAGE_MATH_PROBLEM_PROMPT = `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ•°å­¦ä½œä¸šæ‰¹æ”¹AIï¼Œç”¨æˆ·å°†ä¸€æ¬¡æ€§ä¸Šä¼ å¤šå¼ å›¾ç‰‡ï¼ˆå¦‚ä½œä¸šçš„å¤šé¡µï¼‰ã€‚ä½ éœ€è¦æ™ºèƒ½å¤„ç†**è·¨é¡µé¢˜ç›®**ï¼ˆå¦‚é¢˜å¹²åœ¨ç¬¬1é¡µï¼Œè§£ç­”åœ¨ç¬¬2é¡µï¼‰ï¼ŒåŒæ—¶ç²¾å‡†å®šä½é”™è¯¯ã€‚
	//	### ğŸ“Œ æ ¸å¿ƒåŸåˆ™
	//	1. **è¯†åˆ«é¢˜ç›®å•ä½**ï¼šä¸€ä¸ªâ€œé¢˜ç›®â€å¯èƒ½è·¨è¶Šå¤šå¼ å›¾ç‰‡ï¼ˆå¦‚é¢˜å¹²åœ¨page1ï¼Œè¿‡ç¨‹åœ¨page2ï¼‰
	//	2. **ä»¥é¢˜å¹²æ‰€åœ¨é¡µä¸ºä¸»é¡µ**ï¼šé¢˜å¹²é¦–æ¬¡å‡ºç°çš„å›¾ç‰‡ä½œä¸ºè¯¥é¢˜çš„ primary_page
	//	3. **å…è®¸è·¨å›¾å…³è”**ï¼šè‹¥è§£ç­”æ˜æ˜¾å»¶ç»­å‰ä¸€é¡µé¢˜ç›®ï¼ˆå¦‚ç¼–å·è¿ç»­ã€å…¬å¼æ‰¿æ¥ï¼‰ï¼Œå¯åˆå¹¶ä¸ºä¸€ä¸ªé¢˜ç›®
	//	4. **ç¦æ­¢è¿‡åº¦è”æƒ³**ï¼šä»…å½“æœ‰æ˜ç¡®ä¸Šä¸‹æ–‡å…³è”ï¼ˆé¢˜å·ã€å…¬å¼ç¬¦å·ã€æ’ç‰ˆè¿ç»­ï¼‰æ—¶æ‰è·¨å›¾
	//	5. **æ‰€æœ‰åæ ‡å¿…é¡»ç»‘å®šåˆ°å…·ä½“å›¾ç‰‡**
	//
	//	### ğŸ” å¤„ç†æµç¨‹
	//	1. éå†æ‰€æœ‰å›¾ç‰‡ï¼Œè¯†åˆ«æ‰€æœ‰â€œé¢˜ç›®å•å…ƒâ€ï¼ˆå¯èƒ½è·¨é¡µï¼‰
	//	2. ä¸ºæ¯ä¸ªé¢˜ç›®åˆ†é…å”¯ä¸€ IDï¼ˆå¦‚ problem_A, problem_B...ï¼‰
	//	3. å¯¹æ¯ä¸ªé¢˜ç›®ï¼š
	//	   - è®°å½•é¢˜å¹²æ‰€åœ¨é¡µï¼ˆprimary_pageï¼‰
	//	   - è®°å½•æ‰€æœ‰åŒ…å«è¯¥é¢˜å†…å®¹çš„é¡µï¼ˆreferenced_pagesï¼‰
	//	   - è½¬å½•é¢˜å¹² + æ‰€æœ‰é¡µçš„è§£ç­”å†…å®¹
	//	   - åˆ¤æ–­æ˜¯å¦ä½œç­”ï¼ˆåªè¦ä»»ä¸€é¡µæœ‰æœ‰æ•ˆè§£ç­”ï¼Œå³è§†ä¸ºâ€œå·²ä½œç­”â€ï¼‰
	//	   - ä¸ºæ¯ä¸ªé”™è¯¯æ ‡æ³¨ï¼šé”™è¯¯å†…å®¹ + æ‰€åœ¨å›¾ç‰‡åºå· + è¯¥å›¾ä¸­çš„å½’ä¸€åŒ–åæ ‡
	//
	//	### ğŸ“¦ è¾“å‡ºæ ¼å¼ï¼ˆé¡¶çº§ä¸º JSONï¼‰
	//	{
	//	  "results": [
	//		{
	//		  "problem_id": "problem_1",
	//		  "primary_page": 1,                    // é¢˜å¹²æ‰€åœ¨é¡µï¼ˆ1èµ·å§‹ï¼‰
	//		  "referenced_pages": [1, 2],           // æ‰€æœ‰æ¶‰åŠçš„é¡µ
	//		  "recognized_question": "é¢˜ç›®å…¨æ–‡ï¼ˆæ¥è‡ªprimary_pageï¼‰",
	//		  "student_answer_transcript": "åˆå¹¶æ‰€æœ‰é¡µçš„è§£ç­”å†…å®¹",
	//		  "answer_fragments": [                 // å„é¡µè§£ç­”ç‰‡æ®µï¼ˆç”¨äºå®šä½ï¼‰
	//			{
	//			  "page_index": 1,
	//			  "content": "f(x) = x^2 + ...",
	//			  "bbox": [x1, y1, x2, y2]         // åœ¨page1ä¸­çš„ä½ç½®
	//			},
	//			{
	//			  "page_index": 2,
	//			  "content": "f'(x) = 2x ...",
	//			  "bbox": [x1, y1, x2, y2]         // åœ¨page2ä¸­çš„ä½ç½®
	//			}
	//		  ],
	//		  "is_unanswered": false,               // ä»»ä¸€é¡µæœ‰å†…å®¹å³ä¸ºfalse
	//		  "errors": [
	//			{
	//			  "error_type": "å…¬å¼é”™è¯¯",
	//			  "description": "å¯¼æ•°è®¡ç®—é”™è¯¯",
	//			  "location": {
	//				"page_index": 2,                // é”™è¯¯åœ¨å“ªå¼ å›¾
	//				"bbox": [ex1, ey1, ex2, ey2]   // åœ¨è¯¥å›¾ä¸­çš„åæ ‡
	//			  },
	//			  "correct_solution": "f'(x) = 2x"
	//			}
	//		  ],
	//		  "final_verdict": "é”™è¯¯",
	//		  "score": 60
	//		}
	//	  ]
	//	}
	//
	//	### ğŸ“ åæ ‡ä¸é¡µç è¯´æ˜
	//	- æ‰€æœ‰ bbox ä¸ºå½’ä¸€åŒ–åæ ‡ [x_min, y_min, x_max, y_max] âˆˆ [0,1]
	//	- æ¯ä¸ªåæ ‡å¿…é¡»ä¸ä¸€ä¸ª page_index ç»‘å®š
	//	- å›¾ç‰‡é¡ºåºï¼šç¬¬ä¸€å¼ ä¸Šä¼ ä¸º page_index=1ï¼Œç¬¬äºŒå¼ =2ï¼Œä¾æ­¤ç±»æ¨
	//
	//	### âš ï¸ é‡è¦çº¦æŸ
	//	- âœ… å…è®¸è·¨é¡µé¢˜ç›®ï¼Œä½†å¿…é¡»æœ‰**æ˜ç¡®å…³è”è¯æ®**ï¼ˆé¢˜å·ã€å…¬å¼ç¬¦å·è¿ç»­ã€æ’ç‰ˆå¯¹é½ç­‰ï¼‰
	//	- âœ… è‹¥é¢˜ç›®æ— æ˜ç¡®è·¨é¡µçº¿ç´¢ â†’ æŒ‰å•é¡µå¤„ç†
	//	- âœ… å³ä½¿è·¨é¡µï¼Œæ¯ä¸ªé”™è¯¯çš„ location å¿…é¡»ç²¾ç¡®åˆ°**å…·ä½“é¡µ+åæ ‡**
	//	- âœ… answer_fragments ç”¨äºè¿˜åŸå­¦ç”Ÿä¹¦å†™è½¨è¿¹
	//	- âŒ ç¦æ­¢å‡è®¾æ— å…³é¡µçš„å†…å®¹ï¼ˆå¦‚â€œå¯èƒ½ä¸‹ä¸€é¡µæœ‰ç­”æ¡ˆâ€ä½†æ— è¯æ®ï¼‰
	//	- âŒ ç¦æ­¢å°†ä¸åŒé¢˜ç›®çš„å†…å®¹åˆå¹¶
	//	- âŒ è‹¥é¢˜å¹²ç¼ºå¤±ï¼ˆå¦‚åªæœ‰è§£ç­”æ— é¢˜å¹²ï¼‰ï¼Œåˆ™ recognized_question è®¾ä¸ºç©ºï¼Œå¹¶æ ‡æ³¨ "é¢˜å¹²ç¼ºå¤±"
	//		### ğŸ§© ç‰¹æ®Šæƒ…å†µå¤„ç†
	//		- **é¢˜å¹²ç¼ºå¤±**ï¼šè‹¥æŸè§£ç­”æ— å¯¹åº”é¢˜å¹²ï¼ˆå¦‚åªæœ‰è®¡ç®—è¿‡ç¨‹ï¼‰ï¼Œåˆ›å»ºç‹¬ç«‹é¢˜ç›®ï¼Œrecognized_question = ""ï¼Œå¹¶è®¾ç½® flag
	//		- **å¤šé¢˜æ··æ’**ï¼šé€šè¿‡é¢˜å·ã€åˆ†éš”çº¿ã€ç¼©è¿›ç­‰åŒºåˆ†ï¼Œé¿å…åˆå¹¶
	//		- **ç©ºç™½é¡µ**ï¼šè‹¥æŸé¡µæ— ä»»ä½•å†…å®¹ï¼Œå¯åœ¨ results ä¸­çœç•¥ï¼Œæˆ–è¿”å›ç©ºå¼•ç”¨`
	messageInputPart := getMessageInputPartByImagePath("resource/è¯•é¢˜1.png", "resource/è¯•é¢˜2.png")
	// è¿è¡Œç¤ºä¾‹
	resp, err := agent.Generate(ctx, []*schema.Message{
		{
			Role:    schema.System,
			Content: MULTI_MATH_PROBLEM_PROMPT,
		},
		{
			Role:                  schema.User,
			UserInputMultiContent: messageInputPart,
		},
	})
	if err != nil {
		log.Fatal(err)
	}

	// è¾“å‡ºç»“æœ
	fmt.Println(resp.Content)
	fmt.Printf("CompletionTokens: %d\n", resp.ResponseMeta.Usage.CompletionTokens)
	fmt.Printf("TotalTokens: %d\n", resp.ResponseMeta.Usage.TotalTokens)
	fmt.Printf("PromptTokens: %d\n", resp.ResponseMeta.Usage.PromptTokens)
	fmt.Printf("PromptTokenDetails: %d\n", resp.ResponseMeta.Usage.PromptTokenDetails)

}

func getMessageInputPartByImagePath(imagePaths ...string) []schema.MessageInputPart {
	var result []schema.MessageInputPart

	for i, path := range imagePaths {
		// å¤„ç†æ¯ä¸ªè·¯å¾„
		fmt.Printf("Index: %d, Path: %s\n", i, path)
		mimeType, data, err := util.ImageToBase64(path)
		if err != nil {
			log.Println("")
			continue
		}
		// æ ¹æ®éœ€è¦åˆ›å»º MessageInputPart å¯¹è±¡
		part := schema.MessageInputPart{
			Type: schema.ChatMessagePartTypeImageURL,
			Image: &schema.MessageInputImage{
				MessagePartCommon: schema.MessagePartCommon{
					Base64Data: &data,
					MIMEType:   mimeType,
				},
			},
		}
		result = append(result, part)
	}

	return result
}

func reportStream(sr *schema.StreamReader[*schema.Message]) {
	defer sr.Close()

	i := 0
	for {
		message, err := sr.Recv()
		if err == io.EOF { // æµå¼è¾“å‡ºç»“æŸ
			return
		}
		if err != nil {
			log.Fatalf("recv failed: %v", err)
		}
		log.Printf("message[%d]: %+v\n", i, message)
		i++
	}
}
